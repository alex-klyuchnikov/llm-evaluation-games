import { useEffect, useMemo, useState } from 'react'
import { llmModels, type Game, type LlmModel, type Quant } from './data'

type ViewState =
  | { type: 'models' }
  | { type: 'games'; modelId: string }

const formatDate = (value: string) =>
  new Date(value).toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'short',
    day: '2-digit',
  })

const findModel = (models: LlmModel[], id: string) =>
  models.find((model) => model.id === id)

const countModelGames = (model: LlmModel) => {
  const baseCount = model.games?.length ?? 0
  const quantCount =
    model.quants?.reduce((sum, quant) => sum + quant.games.length, 0) ?? 0
  return baseCount + quantCount
}

const countAllGames = (models: LlmModel[]) =>
  models.reduce((sum, model) => sum + countModelGames(model), 0)

export default function App() {
  const [view, setView] = useState<ViewState>({ type: 'models' })
  const [theme, setTheme] = useState<'light' | 'dark'>(() => {
    const stored = localStorage.getItem('theme')
    if (stored === 'light' || stored === 'dark') return stored
    return window.matchMedia('(prefers-color-scheme: dark)').matches
      ? 'dark'
      : 'light'
  })

  useEffect(() => {
    document.body.dataset.theme = theme
    localStorage.setItem('theme', theme)
  }, [theme])

  const [selectedQuantId, setSelectedQuantId] = useState<string | null>(null)

  const selectedModel = useMemo(() => {
    if (view.type !== 'games') return null
    return findModel(llmModels, view.modelId) ?? null
  }, [view])

  useEffect(() => {
    if (view.type !== 'games') {
      setSelectedQuantId(null)
      return
    }

    if (!selectedModel?.quants?.length) {
      setSelectedQuantId(null)
      return
    }

    const exists = selectedModel.quants.some(
      (quant) => quant.id === selectedQuantId
    )
    if (!exists) {
      setSelectedQuantId(selectedModel.quants[0].id)
    }
  }, [view, selectedModel, selectedQuantId])

  const selectedQuant: Quant | null = useMemo(() => {
    if (!selectedModel?.quants?.length || !selectedQuantId) return null
    return (
      selectedModel.quants.find((quant) => quant.id === selectedQuantId) ?? null
    )
  }, [selectedModel, selectedQuantId])

  return (
    <div className="page">
      <header className="hero">
        <div>
          <p className="eyebrow">LLM Evaluation</p>
          <h1>Game Showcase</h1>
          <p className="lede">
            Browse games generated by each model. Each game opens in a new tab
            as a single HTML file.
          </p>
        </div>
        <div className="hero-meta">
          <div className="meta-card">
            <span className="meta-label">Models</span>
            <span className="meta-value">{llmModels.length}</span>
          </div>
          <div className="meta-card">
            <span className="meta-label">Games</span>
            <span className="meta-value">
              {countAllGames(llmModels)}
            </span>
          </div>
        </div>
      </header>

      <main>
        {view.type === 'models' && (
          <section className="card">
            <div className="card-header">
              <h2>Models</h2>
              <p>Select a model to view its games.</p>
            </div>
            <div className="grid">
              {llmModels.map((model) => (
                <button
                  className="model-card"
                  key={model.id}
                  type="button"
                  onClick={() => setView({ type: 'games', modelId: model.id })}
                >
                  <div>
                    <h3>{model.name}</h3>
                    <p>{model.description}</p>
                  </div>
                  <span className="count">{countModelGames(model)} games</span>
                </button>
              ))}
            </div>
          </section>
        )}

        {view.type === 'games' && (
          <section className="card">
            <div className="card-header">
              <div>
                <p className="eyebrow">Model</p>
                <h2>{selectedModel?.name ?? 'Unknown model'}</h2>
                <p>{selectedModel?.description ?? 'Model not found.'}</p>
              </div>
              <button
                className="ghost-button"
                type="button"
                onClick={() => setView({ type: 'models' })}
              >
                ← Back to models
              </button>
            </div>

            {selectedModel?.quants?.length && (
              <div className="quant-tabs">
                <div className="tabs">
                  {selectedModel.quants.map((quant) => (
                    <button
                      key={quant.id}
                      type="button"
                      className={
                        selectedQuantId === quant.id
                          ? 'tab-button active'
                          : 'tab-button'
                      }
                      onClick={() => setSelectedQuantId(quant.id)}
                    >
                      {quant.name}
                    </button>
                  ))}
                </div>
                <p className="tab-description">
                  {selectedQuant?.description ?? 'Select a quant to view games.'}
                </p>
              </div>
            )}

            <div className="list">
              {(selectedModel?.quants?.length
                ? selectedQuant?.games
                : selectedModel?.games
              )?.map((game) => (
                <GameRow key={game.id} game={game} />
              ))}
              {!(selectedModel?.quants?.length
                ? selectedQuant?.games.length
                : selectedModel?.games?.length) && (
                <p className="empty-state">
                  No games yet for this selection.
                </p>
              )}
            </div>
          </section>
        )}
      </main>

      <footer className="footer">
        <div className="footer-meta">
          <span>© Aleksandr Kliuchnikov, 2025</span>
          <a
            href="https://github.com/alex-klyuchnikov"
            target="_blank"
            rel="noreferrer"
          >
            <svg
              viewBox="0 0 24 24"
              role="img"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M12 2a10 10 0 0 0-3.16 19.49c.5.09.68-.21.68-.48v-1.69c-2.78.61-3.37-1.34-3.37-1.34-.45-1.13-1.11-1.43-1.11-1.43-.91-.62.07-.61.07-.61 1 .07 1.53 1.03 1.53 1.03.9 1.54 2.37 1.1 2.95.84.09-.66.35-1.1.63-1.36-2.22-.25-4.56-1.11-4.56-4.95 0-1.1.39-2 1.03-2.7-.1-.25-.45-1.27.1-2.65 0 0 .84-.27 2.75 1.03.8-.22 1.64-.33 2.49-.33s1.7.11 2.49.33c1.9-1.3 2.74-1.03 2.74-1.03.56 1.38.21 2.4.1 2.65.64.7 1.03 1.6 1.03 2.7 0 3.85-2.34 4.7-4.57 4.95.36.31.68.93.68 1.87v2.77c0 .27.18.58.69.48A10 10 0 0 0 12 2Z"
                fill="currentColor"
              />
            </svg>
            <span>GitHub</span>
          </a>
        </div>
        <button
          className="theme-toggle"
          type="button"
          aria-label={
            theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode'
          }
          onClick={() =>
            setTheme((current) => (current === 'light' ? 'dark' : 'light'))
          }
        >
          {theme === 'light' ? (
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
              <path
                d="M12 3.25a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V4a.75.75 0 0 1 .75-.75Zm0 13.5a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Zm8.75-4.5a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 .75.75Zm-15.25.75H4a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 0 1.5Zm12.02-6.77a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 1 1-1.06 1.06l-1.06-1.06a.75.75 0 0 1 0-1.06Zm-11.08 11.08a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 0 1-1.06 1.06l-1.06-1.06a.75.75 0 0 1 0-1.06Zm12.14 1.06a.75.75 0 0 1 0 1.06l-1.06 1.06a.75.75 0 1 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 0Zm-11.08-11.08a.75.75 0 0 1 0 1.06L6.44 8.35a.75.75 0 1 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 0Z"
                fill="currentColor"
              />
            </svg>
          ) : (
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
              <path
                d="M12.74 3.25a.75.75 0 0 1 .82.96 7.5 7.5 0 0 0 6.23 9.83.75.75 0 0 1 .46 1.18 9 9 0 1 1-11.17-12 0.75.75 0 0 1 .96.82 7.5 7.5 0 1 0 2.7-.79Z"
                fill="currentColor"
              />
            </svg>
          )}
        </button>
      </footer>
    </div>
  )
}

function GameRow({ game }: { game: Game }) {
  return (
    <div className="game-row">
      <div>
        <h3>{game.title}</h3>
        <p>{game.description}</p>
      </div>
      <div className="game-meta">
        <span className="date">{formatDate(game.createdAt)}</span>
        <a
          className="primary-button"
          href={game.htmlPath}
          target="_blank"
          rel="noreferrer"
        >
          Open game
        </a>
      </div>
    </div>
  )
}
